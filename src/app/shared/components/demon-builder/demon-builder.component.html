<div class="builder-div">
	<!-- User Entry Form -->
	<div class="form-div">
		<!-- Demon and Level -->
		<mat-form-field class="name-form-field" appearance="fill">
			<mat-label>Demon</mat-label>
			<input
				type="text"
				placeholder="Mara"
				aria-label="Demon Name"
				matInput
				[formControl]="demonControl"
				[matAutocomplete]="auto"
			/>
			<mat-autocomplete #auto="matAutocomplete">
				@for (demon of filteredDemons | async; track $index) {
					<mat-option [value]="demon">
						{{ demon }}
					</mat-option>
				}
			</mat-autocomplete>
		</mat-form-field>
		<mat-form-field class="level-form-field" appearance="fill">
			<mat-label>Max Level</mat-label>
			<input type="number" matInput [formControl]="levelControl" />
		</mat-form-field>
		<!-- Skills -->
		<div class="skills-div" layout="column">
			@for (skillControl of skillControls; track $index) {
				<form>
					<mat-form-field class="skill-form-field" appearance="fill">
						<mat-label>Skill {{ $index + 1 }}</mat-label>
						<input
							type="text"
							placeholder="Maragi"
							aria-label="Skill"
							matInput
							[formControl]="skillControl"
							[matAutocomplete]="auto"
						/>
						<mat-autocomplete #auto="matAutocomplete">
							@for (
								skill of filteredSkills[$index] | async;
								track $index
							) {
								<mat-option [value]="skill">
									{{ skill }}
								</mat-option>
							}
						</mat-autocomplete>
					</mat-form-field>
				</form>
			}
		</div>
		<!-- Buttons -->
		<div class="buttons-div">
			<button
				(click)="startWebWorker()"
				class="builder-button"
				color="primary"
				mat-raised-button
			>
				<p>Calculate</p>
			</button>
			<button
				(click)="stopWebWorker()"
				class="builder-button"
				color="primary"
				mat-raised-button
			>
				<p>Stop</p>
			</button>
			<button
				(click)="resetDemonBuilder()"
				class="builder-button"
				color="primary"
				mat-raised-button
			>
				<p>Clear</p>
			</button>
		</div>
		<div class="test">
			<button (click)="test()" color="primary" mat-raised-button>
				Test
			</button>
		</div>
	</div>
	<!-- Results Table -->
	<div class="results-div">
		<!-- Loading -->
		@if (calculating) {
			@if (loadingIcon === "default") {
				<mat-spinner></mat-spinner>
			} @else {
				<img src="{{ loadingIcon }}" />
			}
		} @else {
			@if (userError) {
				<p>{{ userError }}</p>
			} @else {
				@if (buildsSource.data.length == 0) {
					<p>Create a demon with your desired skills on the left.</p>
				}
			}
		}
		@if (buildsSource.data.length > 0) {
			<p>{{ buildsSource.data.length }} successful recipes found.</p>
		}
		@if (fuseCount > 0) {
			<p>{{ fuseCount | comma }} fusion attempted...</p>
			@if (calculating) {
				<p>
					You can stop whenever you want and view the current results.
				</p>
			}
		}
		<!-- Recipe Display -->
		@if (buildsSource.data.length > 0) {
			@if (!calculating) {
				<p>Ran for {{ deltaTime | time }}</p>
			}
			<table
				mat-table
				[dataSource]="buildsSource"
				multiTemplateDataRows
				class="mat-elevation-z12"
				matSort
			>
				<!-- Header Rows -->
				<ng-container matColumnDef="result">
					<th
						mat-header-cell
						class="header-cell"
						clas="header-cell"
						*matHeaderCellDef
						mat-sort-header
					>
						Result
					</th>
					<td mat-cell *matCellDef="let build">
						<p>{{ build.result }}</p>
					</td>
				</ng-container>
				<ng-container matColumnDef="cost">
					<th
						mat-header-cell
						class="header-cell"
						clas="header-cell"
						*matHeaderCellDef
						mat-sort-header
					>
						Cost
					</th>

					<td mat-cell *matCellDef="let build">
						<p>{{ build.cost | comma }}</p>
					</td>
				</ng-container>
				<ng-container matColumnDef="level">
					<th
						mat-header-cell
						class="header-cell"
						clas="header-cell"
						*matHeaderCellDef
						mat-sort-header
					>
						Level Required
					</th>
					<td mat-cell *matCellDef="let build">
						<p>{{ build.level }}</p>
					</td>
				</ng-container>
				<ng-container matColumnDef="fusions">
					<th
						mat-header-cell
						class="header-cell"
						clas="header-cell"
						*matHeaderCellDef
						mat-sort-header
					>
						Steps
					</th>
					<td mat-cell *matCellDef="let build">
						<p>{{ build.fusions.length }}</p>
					</td>
				</ng-container>
				<!-- Expanded Recipe -->
				<ng-container matColumnDef="expandedDetail">
					<td
						mat-cell
						*matCellDef="let build"
						[attr.colspan]="columnsToDisplay.length"
					>
						<div
							class="recipe-detail"
							[@detailExpand]="
								build == expandedRecipe
									? 'expanded'
									: 'collapsed'
							"
						>
							<!-- Directions Display -->
							<div class="directions-div">
								<!-- Loop through steps -->
								@for (step of build.fusions; track $index) {
									<div ngPreserveWhitespaces>
										<!-- Step Number -->
										<span class="step-number">
											Step {{ $index + 1 }}:
										</span>
										&ngsp;
										<!-- Fusion Direction -->
										@if (step.sources.length <= 2) {
											<span class="direction">Fuse</span>
											&ngsp;
										} @else {
											<span class="direction">
												Use special fusion with
											</span>
											&ngsp;
										}
										<!-- loop through sources in step -->
										@for (
											source of step.sources;
											track $index
										) {
											@if (
												$index ==
												step.sources.length - 1
											) {
												<span class="direction"
													>and
												</span>
												&ngsp;
												<a
													routerLink="{{ source }}"
													class="source"
												>
													{{ source }}
												</a>
												&ngsp;
											} @else {
												<span class="source">
													{{ source }},
												</span>
												&ngsp;
											}
										}
										<span class="direction">to make</span>
										&ngsp;
										<span class="source">
											{{ step.result }}.
										</span>
										&ngsp;
										<span class="source">
											Have {{ step.result }} inherit
										</span>
										&ngsp;
										<!-- loop through inheritted skills in step -->
										@for (
											skill of build.inherittedSkills[
												$index
											];
											track $index
										) {
											@if (
												$index ==
												step.sources.length - 1
											) {
												<span class="direction">
													and {{ skill }}.
												</span>
												&ngsp;
											} @else {
												<span class="direction">
													{{ skill }},
												</span>
												&ngsp;
											}
										}
									</div>
								}
								<div class="final-step-div">
									<span>{{ build.result }} will learn</span>
									&ngsp;
									@for (
										skill of build.innates;
										track $index
									) {
										@if (
											$index == build.innates.length - 1
										) {
											<span>
												and {{ skill }} on their own.
											</span>
											&ngsp;
										} @else {
											<span>{{ skill }},</span>&ngsp;
										}
									}
								</div>
							</div>
						</div>
					</td>
				</ng-container>
				<tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
				<tr
					mat-row
					*matRowDef="let build; columns: columnsToDisplay"
					class="recipe-row"
					[class.recipe-row]="expandedRecipe === build"
					(click)="
						expandedRecipe = expandedRecipe === build ? null : build
					"
				></tr>
				<tr
					mat-row
					*matRowDef="let row; columns: ['expandedDetail']"
					class="recipe-detail-row"
				></tr>
			</table>
		}
	</div>
</div>
